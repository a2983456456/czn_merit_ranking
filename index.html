<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>隊伍瀏覽</title>
  <style>
    html, body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 18px;
      min-height: 100%;
    }

    main {
      padding: 24px 32px 48px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ---------- 上次更新 ---------- */
    #updateInfo {
      margin-bottom: 16px;
      font-size: 18px;
      color: #cbd5e1;
    }

    /* ---------- 表格 ---------- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #020617;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    thead {
      background: #0b1120;
    }
    thead th {
      padding: 16px 12px;
      font-size: 20px;
      font-weight: 700;
      color: #cbd5e1;
      white-space: nowrap;
      border-bottom: 1px solid #1f2937;
    }
    tbody td {
      padding: 14px 12px;
      font-size: 18px;
      border-bottom: 1px solid #0f172a;
      vertical-align: middle;
    }
    tbody tr:hover {
      background: #111827;
    }

    td.rank {
      font-weight: 700;
      color: #60a5fa;
      width: 60px;
      text-align: center;
      font-size: 22px;
    }
    td.score {
      font-weight: 800;
      color: #facc15;
      text-align: right;
      font-size: 22px;
      font-variant-numeric: tabular-nums;
    }

    /* ---------- 隊伍角色 ---------- */
    .roles-cell {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
    }
    .role-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 4px 12px 4px 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #334155;
      max-width: 220px;
      overflow: hidden;
      white-space: nowrap;
    }
    .role-pill img {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      object-fit: cover;
    }
    .role-name {
      font-size: 17px;
      font-weight: 500;
    }

    /* ---------- 角色篩選區 ---------- */
    .role-filters {
      margin-top: 16px;
      padding: 16px;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px 6px 8px;
      border-radius: 999px;
      border: 3px solid #64748b;
      background: #020617;
      cursor: pointer;
      transition: 0.15s;
    }
    .filter-pill img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .filter-pill .name {
      font-size: 18px;
      font-weight: 500;
    }
    .filter-pill .mark {
      font-size: 22px;
      font-weight: 800;
    }

    .filter-neutral { border-color: #64748b; }
    .filter-must    { border-color: #16a34a; background: rgba(22,163,74,0.25); }
    .filter-not     { border-color: #dc2626; background: rgba(220,38,38,0.25); }

  </style>
</head>

<body>
  <main>

    <!-- 上次更新時間 -->
    <div id="updateInfo">
      上次更新：<span id="lastUpdateText">讀取中…</span>
    </div>

    <!-- 角色篩選區 -->
    <div id="roleFilters" class="role-filters"></div>

    <!-- 表格 -->
    <table>
      <thead>
        <tr>
          <th>名次</th>
          <th>先鋒隊</th>
          <th>後援隊</th>
          <th>分數</th>
        </tr>
      </thead>
      <tbody id="teamBody"></tbody>
    </table>

  </main>

  <script>
    const IMG_BASE = "templates";
    const CSV_PATH = "results.csv";
    const LAST_UPDATE_PATH = "last_update.txt";

    let allTeams = [];
    let filteredTeams = [];
    const roleStates = {};
    let lastUpdateDate = null;

    /* ----------- Load CSV ----------- */
    async function loadCSV() {
      const res = await fetch(CSV_PATH);
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/);
      rows.shift();

      return rows.map((line, i) => {
        const col = line.split(",");
        return {
          rank: i + 1,
          roles: col.slice(0, 6),
          score: Number(col[6]) || 0
        };
      });
    }

    /* ----------- Build Role Pill ----------- */
    function rolePill(role) {
      const div = document.createElement("div");
      div.className = "role-pill";

      const img = document.createElement("img");
      img.src = `${IMG_BASE}/${encodeURIComponent(role)}.png`;
      img.onerror = () => img.classList.add("hidden");
      div.appendChild(img);

      const name = document.createElement("span");
      name.className = "role-name";
      name.textContent = role;
      div.appendChild(name);

      return div;
    }

    /* ----------- Render Table ----------- */
    function renderTeams(list) {
      const body = document.getElementById("teamBody");
      body.innerHTML = "";

      list.forEach(t => {
        const tr = document.createElement("tr");

        const tdR = document.createElement("td");
        tdR.className = "rank";
        tdR.textContent = t.rank;
        tr.appendChild(tdR);

        const tdF = document.createElement("td");
        const f = document.createElement("div");
        f.className = "roles-cell";
        t.roles.slice(0, 3).forEach(r => f.appendChild(rolePill(r)));
        tdF.appendChild(f);
        tr.appendChild(tdF);

        const tdB = document.createElement("td");
        const b = document.createElement("div");
        b.className = "roles-cell";
        t.roles.slice(3, 6).forEach(r => b.appendChild(rolePill(r)));
        tdB.appendChild(b);
        tr.appendChild(tdB);

        const tdS = document.createElement("td");
        tdS.className = "score";
        tdS.textContent = t.score.toLocaleString();
        tr.appendChild(tdS);

        body.appendChild(tr);
      });
    }

    /* ----------- Role Filters ----------- */
    function buildFilters() {
      const box = document.getElementById("roleFilters");
      box.innerHTML = "";

      const set = new Set();
      allTeams.forEach(t => t.roles.forEach(r => {
        if (!r.startsWith("UNKNOWN(")) set.add(r);
      }));

      [...set].sort().forEach(role => {
        roleStates[role] = 0;

        const pill = document.createElement("div");
        pill.className = "filter-pill filter-neutral";
        pill.dataset.role = role;

        const img = document.createElement("img");
        img.src = `${IMG_BASE}/${encodeURIComponent(role)}.png`;
        img.onerror = () => img.classList.add("hidden");
        pill.appendChild(img);

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = role;
        pill.appendChild(name);

        const mark = document.createElement("span");
        mark.className = "mark";
        mark.textContent = "";
        pill.appendChild(mark);

        pill.addEventListener("click", () => cycleFilter(pill));
        box.appendChild(pill);
      });
    }

    function cycleFilter(pill) {
      const role = pill.dataset.role;
      let s = roleStates[role];

      s = s === 0 ? 1 : s === 1 ? -1 : 0;
      roleStates[role] = s;

      const mark = pill.querySelector(".mark");
      pill.classList.remove("filter-neutral","filter-must","filter-not");

      if (s === 1) {
        pill.classList.add("filter-must");
        mark.textContent = "✓";
      } else if (s === -1) {
        pill.classList.add("filter-not");
        mark.textContent = "✕";
      } else {
        pill.classList.add("filter-neutral");
        mark.textContent = "";
      }

      applyFilter();
    }

    function applyFilter() {
      const must = [];
      const not = [];

      for (const [r, s] of Object.entries(roleStates)) {
        if (s === 1) must.push(r);
        else if (s === -1) not.push(r);
      }

      filteredTeams = allTeams.filter(team => {
        for (const r of must) if (!team.roles.includes(r)) return false;
        for (const r of not)  if (team.roles.includes(r)) return false;
        return true;
      });

      renderTeams(filteredTeams);
    }

    /* ----------- Update Time ----------- */
    function formatTimeDiff(fromDate, now) {
      const diffMs = now - fromDate;
      if (diffMs < 0) return "剛剛";

      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "剛剛";

      if (diffMin < 60) return diffMin + " 分鐘前";

      const hr = Math.floor(diffMin / 60);
      const rm = diffMin % 60;
      if (hr < 24) {
        return rm === 0 ? `${hr} 小時前` : `${hr} 小時 ${rm} 分鐘前`;
      }

      const day = Math.floor(hr / 24);
      return day + " 天前";
    }

    function updateLastUpdateLabel() {
      const span = document.getElementById("lastUpdateText");
      if (!lastUpdateDate) {
        span.textContent = "未知";
        return;
      }
      span.textContent = formatTimeDiff(lastUpdateDate, new Date());
    }

    async function loadLastUpdate() {
      try {
        const res = await fetch(LAST_UPDATE_PATH);
        const text = (await res.text()).trim();
        lastUpdateDate = new Date(text);

        updateLastUpdateLabel();
        setInterval(updateLastUpdateLabel, 60 * 1000);

      } catch (e) {
        document.getElementById("lastUpdateText").textContent = "載入失敗";
      }
    }

    /* ----------- INIT ----------- */
    async function init() {
      allTeams = await loadCSV();
      filteredTeams = allTeams.slice();

      buildFilters();
      renderTeams(filteredTeams);

      loadLastUpdate();
    }

    init();
  </script>
</body>
</html>
