<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>隊伍瀏覽</title>
  <style>
    html, body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 18px;
      min-height: 100%;
    }

    .hidden {
      display: none !important;
    }

    main {
      padding: 24px 32px 48px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* 上次更新 */
    #updateInfo {
      margin-bottom: 16px;
      font-size: 18px;
      color: #cbd5e1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #1f2937;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 18px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: 0.15s;
    }
    .tab-btn.active {
      color: #e5e7eb;
      border-color: #3b82f6;
      font-weight: 600;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* 排行榜：表格 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #020617;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    thead {
      background: #0b1120;
    }
    thead th {
      padding: 16px 12px;
      font-size: 20px;
      font-weight: 700;
      color: #cbd5e1;
      white-space: nowrap;
      border-bottom: 1px solid #1f2937;
    }
    tbody td {
      padding: 14px 12px;
      font-size: 18px;
      border-bottom: 1px solid #0f172a;
      vertical-align: middle;
    }
    tbody tr:hover {
      background: #111827;
    }
    td.rank {
      font-weight: 700;
      color: #60a5fa;
      width: 60px;
      text-align: center;
      font-size: 22px;
    }
    td.score {
      font-weight: 800;
      color: #facc15;
      text-align: right;
      font-size: 22px;
      font-variant-numeric: tabular-nums;
    }

    .roles-cell {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
    }
    .role-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 4px 12px 4px 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #334155;
      max-width: 220px;
      overflow: hidden;
      white-space: nowrap;
    }
    .role-pill img {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      object-fit: cover;
    }
    .role-name {
      font-size: 17px;
      font-weight: 500;
    }

    /* 角色篩選區（排行榜頁籤用） */
    .role-filters {
      margin-top: 8px;
      margin-bottom: 8px;
      padding: 16px;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px 6px 8px;
      border-radius: 999px;
      border: 3px solid #64748b;
      background: #020617;
      cursor: pointer;
      transition: 0.15s;
    }
    .filter-pill img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .filter-pill .name {
      font-size: 18px;
      font-weight: 500;
    }
    .filter-pill .mark {
      font-size: 22px;
      font-weight: 800;
    }
    .filter-neutral { border-color: #64748b; }
    .filter-must    { border-color: #16a34a; background: rgba(22,163,74,0.25); }
    .filter-not     { border-color: #dc2626; background: rgba(220,38,38,0.25); }

    /* 使用率區塊通用布局 */
    .usage-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .usage-col {
      flex: 1;
      min-width: 280px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 16px;
      box-sizing: border-box;
    }
    .usage-col-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #e5e7eb;
    }

    /* 角色使用率：每一行 */
    .role-usage-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .role-usage-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
    }
    .role-usage-name {
      width: 90px;
      font-size: 16px;
      margin-right: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .role-usage-bar-wrap {
      flex: 1;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
      margin-right: 8px;
      height: 20px;
    }
    .role-usage-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .role-usage-count {
      width: 90px;
      font-size: 16px;
      text-align: right;
    }

    /* 三人小隊使用率行 */
    .squad-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .squad-icons {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-right: 8px;
    }
    .squad-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }
    .squad-names {
      width: 120px;
      font-size: 14px;
      margin-right: 8px;
      line-height: 1.2;
    }
    .squad-bar-wrap {
      flex: 1;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
      margin-right: 8px;
      height: 20px;
    }
    .squad-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }
    .squad-count {
      width: 100px;
      text-align: right;
      font-size: 16px;
    }

    @media (max-width: 900px) {
      main {
        padding: 16px;
      }
      .usage-col {
        min-width: 100%;
      }
    }
  </style>
</head>

<body>
  <main>
    <!-- 上次更新時間 -->
    <div id="updateInfo">
      上次更新：<span id="lastUpdateText">讀取中…</span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-ranking">排行榜</button>
      <button class="tab-btn" data-tab="tab-role-usage">角色使用率</button>
      <button class="tab-btn" data-tab="tab-team-usage">隊伍使用率</button>
    </div>

    <!-- 排行榜 -->
    <section id="tab-ranking" class="tab-panel active">
      <div id="roleFilters" class="role-filters"></div>

      <table>
        <thead>
          <tr>
            <th>名次</th>
            <th>先鋒隊</th>
            <th>後援隊</th>
            <th>分數</th>
          </tr>
        </thead>
        <tbody id="teamBody"></tbody>
      </table>
    </section>

    <!-- 角色使用率 -->
    <section id="tab-role-usage" class="tab-panel">
      <div class="usage-row">
        <div class="usage-col">
          <div class="usage-col-title">整體</div>
          <div id="roleUsageOverall"></div>
        </div>
        <div class="usage-col">
          <div class="usage-col-title">先鋒隊</div>
          <div id="roleUsageFront"></div>
        </div>
        <div class="usage-col">
          <div class="usage-col-title">後援隊</div>
          <div id="roleUsageBack"></div>
        </div>
      </div>
    </section>

    <!-- 隊伍使用率（3人小隊） -->
    <section id="tab-team-usage" class="tab-panel">
      <div class="usage-row">
        <div class="usage-col">
          <div class="usage-col-title">先鋒隊三人小隊</div>
          <div id="squadUsageFront"></div>
        </div>
        <div class="usage-col">
          <div class="usage-col-title">後援隊三人小隊</div>
          <div id="squadUsageBack"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const IMG_BASE = "templates";
    const CSV_PATH = "results.csv";
    const LAST_UPDATE_PATH = "last_update.txt";

    let allTeams = [];
    let filteredTeams = [];
    const roleStates = {}; // 0 neutral, 1 must, -1 not
    let lastUpdateDate = null;

    /* ----------- 讀 CSV ----------- */
    async function loadCSV() {
      const res = await fetch(CSV_PATH);
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/);
      rows.shift(); // 移除 header

      return rows.map((line, i) => {
        const col = line.split(",");
        return {
          rank: i + 1,
          roles: col.slice(0, 6),
          score: Number(col[6]) || 0
        };
      });
    }

    /* ----------- 共用：角色 pill ----------- */
    function rolePill(role) {
      const div = document.createElement("div");
      div.className = "role-pill";

      const img = document.createElement("img");
      img.src = `${IMG_BASE}/${encodeURIComponent(role)}.png`;
      img.onerror = () => img.classList.add("hidden");
      div.appendChild(img);

      const name = document.createElement("span");
      name.className = "role-name";
      name.textContent = role;
      div.appendChild(name);

      return div;
    }

    /* ----------- 排行榜：渲染隊伍 ----------- */
    function renderTeams(list) {
      const body = document.getElementById("teamBody");
      body.innerHTML = "";

      list.forEach(t => {
        const tr = document.createElement("tr");

        const tdR = document.createElement("td");
        tdR.className = "rank";
        tdR.textContent = t.rank;
        tr.appendChild(tdR);

        const tdF = document.createElement("td");
        const f = document.createElement("div");
        f.className = "roles-cell";
        t.roles.slice(0, 3).forEach(r => f.appendChild(rolePill(r)));
        tdF.appendChild(f);
        tr.appendChild(tdF);

        const tdB = document.createElement("td");
        const b = document.createElement("div");
        b.className = "roles-cell";
        t.roles.slice(3, 6).forEach(r => b.appendChild(rolePill(r)));
        tdB.appendChild(b);
        tr.appendChild(tdB);

        const tdS = document.createElement("td");
        tdS.className = "score";
        tdS.textContent = t.score.toLocaleString();
        tr.appendChild(tdS);

        body.appendChild(tr);
      });
    }

    /* ----------- 排行榜：角色篩選 ----------- */
    function buildFilters() {
      const box = document.getElementById("roleFilters");
      box.innerHTML = "";

      const set = new Set();
      allTeams.forEach(t => t.roles.forEach(r => {
        if (!r.startsWith("UNKNOWN(")) set.add(r);
      }));

      [...set].sort().forEach(role => {
        roleStates[role] = 0;

        const pill = document.createElement("div");
        pill.className = "filter-pill filter-neutral";
        pill.dataset.role = role;

        const img = document.createElement("img");
        img.src = `${IMG_BASE}/${encodeURIComponent(role)}.png`;
        img.onerror = () => img.classList.add("hidden");
        pill.appendChild(img);

        const name = document.createElement("span");
        name.className = "name";
        name.textContent = role;
        pill.appendChild(name);

        const mark = document.createElement("span");
        mark.className = "mark";
        mark.textContent = "";
        pill.appendChild(mark);

        pill.addEventListener("click", () => cycleFilter(pill));
        box.appendChild(pill);
      });
    }

    function cycleFilter(pill) {
      const role = pill.dataset.role;
      let s = roleStates[role];

      s = s === 0 ? 1 : s === 1 ? -1 : 0;
      roleStates[role] = s;

      const mark = pill.querySelector(".mark");
      pill.classList.remove("filter-neutral","filter-must","filter-not");

      if (s === 1) {
        pill.classList.add("filter-must");
        mark.textContent = "✓";
      } else if (s === -1) {
        pill.classList.add("filter-not");
        mark.textContent = "✕";
      } else {
        pill.classList.add("filter-neutral");
        mark.textContent = "";
      }

      applyFilter();
    }

    function applyFilter() {
      const must = [];
      const not = [];

      for (const [r, s] of Object.entries(roleStates)) {
        if (s === 1) must.push(r);
        else if (s === -1) not.push(r);
      }

      filteredTeams = allTeams.filter(team => {
        for (const r of must) if (!team.roles.includes(r)) return false;
        for (const r of not)  if (team.roles.includes(r)) return false;
        return true;
      });

      renderTeams(filteredTeams);
      // 角色/隊伍使用率目前以 allTeams 為基準，不跟著篩選變
    }

    /* ----------- 上次更新時間 ----------- */
    function formatTimeDiff(fromDate, now) {
      const diffMs = now - fromDate;
      if (diffMs < 0) return "剛剛";

      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "剛剛";

      if (diffMin < 60) return diffMin + " 分鐘前";

      const hr = Math.floor(diffMin / 60);
      const rm = diffMin % 60;
      if (hr < 24) {
        return rm === 0 ? `${hr} 小時前` : `${hr} 小時 ${rm} 分鐘前`;
      }

      const day = Math.floor(hr / 24);
      return day + " 天前";
    }

    function updateLastUpdateLabel() {
      const span = document.getElementById("lastUpdateText");
      if (!lastUpdateDate) {
        span.textContent = "未知";
        return;
      }
      span.textContent = formatTimeDiff(lastUpdateDate, new Date());
    }

    async function loadLastUpdate() {
      try {
        const res = await fetch(LAST_UPDATE_PATH);
        const text = (await res.text()).trim();
        if (!text) throw new Error("空白");
        lastUpdateDate = new Date(text);
        updateLastUpdateLabel();
        setInterval(updateLastUpdateLabel, 60 * 1000);
      } catch (e) {
        const span = document.getElementById("lastUpdateText");
        span.textContent = "載入失敗";
      }
    }

    /* ----------- 角色使用率計算 ----------- */
    function computeRoleUsage() {
      const overall = {};
      const front = {};
      const back = {};

      allTeams.forEach(team => {
        team.roles.forEach((r, idx) => {
          if (r.startsWith("UNKNOWN(")) return;
          overall[r] = (overall[r] || 0) + 1;
          if (idx < 3) {
            front[r] = (front[r] || 0) + 1;
          } else {
            back[r] = (back[r] || 0) + 1;
          }
        });
      });

      const totalOverall = Object.values(overall).reduce((a,b)=>a+b,0);
      const totalFront   = Object.values(front).reduce((a,b)=>a+b,0);
      const totalBack    = Object.values(back).reduce((a,b)=>a+b,0);

      function mapToSortedArray(map, total) {
        const arr = Object.entries(map).map(([role,count]) => ({
          role,
          count,
          percent: total ? (count / total * 100) : 0
        }));
        arr.sort((a,b)=> b.count - a.count || a.role.localeCompare(b.role,"zh-Hant"));
        return arr;
      }

      return {
        overall: mapToSortedArray(overall, totalOverall),
        front:   mapToSortedArray(front, totalFront),
        back:    mapToSortedArray(back, totalBack)
      };
    }

    function renderRoleUsageList(targetId, list) {
      const container = document.getElementById(targetId);
      container.innerHTML = "";

      if (!list.length) {
        container.innerHTML = "<div style='color:#94a3b8'>無資料</div>";
        return;
      }

      const maxCount = list[0].count || 1;

      list.forEach(item => {
        const row = document.createElement("div");
        row.className = "role-usage-row";

        const img = document.createElement("img");
        img.className = "role-usage-icon";
        img.src = `${IMG_BASE}/${encodeURIComponent(item.role)}.png`;
        img.onerror = () => img.classList.add("hidden");
        row.appendChild(img);

        const name = document.createElement("div");
        name.className = "role-usage-name";
        name.textContent = item.role;
        row.appendChild(name);

        const wrap = document.createElement("div");
        wrap.className = "role-usage-bar-wrap";

        const bar = document.createElement("div");
        bar.className = "role-usage-bar";
        bar.style.width = (item.count / maxCount * 100) + "%";
        wrap.appendChild(bar);
        row.appendChild(wrap);

        const cnt = document.createElement("div");
        cnt.className = "role-usage-count";
        cnt.textContent = `${item.count} (${item.percent.toFixed(1)}%)`;
        row.appendChild(cnt);

        container.appendChild(row);
      });
    }

    function renderRoleUsageAll() {
      const usage = computeRoleUsage();
      renderRoleUsageList("roleUsageOverall", usage.overall);
      renderRoleUsageList("roleUsageFront",   usage.front);
      renderRoleUsageList("roleUsageBack",    usage.back);
    }

    /* ----------- 三人小隊使用率（順序無關） ----------- */
    function computeSquadUsage() {
      const frontMap = {};
      const backMap  = {};

      allTeams.forEach(team => {
        const f = team.roles.slice(0,3);
        const b = team.roles.slice(3,6);

        // 如果有 UNKNOWN 就跳過該小隊
        if (!f.some(r => r.startsWith("UNKNOWN("))) {
          const fSorted = [...f].sort((a,b)=>a.localeCompare(b,"zh-Hant"));
          const keyF = fSorted.join("|");
          if (!frontMap[keyF]) {
            frontMap[keyF] = { roles: fSorted, count: 0 };
          }
          frontMap[keyF].count += 1;
        }

        if (!b.some(r => r.startsWith("UNKNOWN("))) {
          const bSorted = [...b].sort((a,b)=>a.localeCompare(b,"zh-Hant"));
          const keyB = bSorted.join("|");
          if (!backMap[keyB]) {
            backMap[keyB] = { roles: bSorted, count: 0 };
          }
          backMap[keyB].count += 1;
        }
      });

      function mapToSortedArray(map) {
        const arr = Object.values(map);
        const total = arr.reduce((a,x)=>a+x.count,0) || 1;
        arr.forEach(x => {
          x.percent = x.count / total * 100;
        });
        arr.sort((a,b)=> b.count - a.count ||
                         a.roles.join(",").localeCompare(b.roles.join(","),"zh-Hant"));
        return arr;
      }

      return {
        front: mapToSortedArray(frontMap),
        back:  mapToSortedArray(backMap)
      };
    }

    function renderSquadUsageList(targetId, list) {
      const container = document.getElementById(targetId);
      container.innerHTML = "";

      if (!list.length) {
        container.innerHTML = "<div style='color:#94a3b8'>無資料</div>";
        return;
      }

      const maxCount = list[0].count || 1;

      list.forEach(item => {
        const row = document.createElement("div");
        row.className = "squad-row";

        const icons = document.createElement("div");
        icons.className = "squad-icons";
        item.roles.forEach(r => {
          const img = document.createElement("img");
          img.className = "squad-icon";
          img.src = `${IMG_BASE}/${encodeURIComponent(r)}.png`;
          img.onerror = () => img.classList.add("hidden");
          icons.appendChild(img);
        });
        row.appendChild(icons);

        const names = document.createElement("div");
        names.className = "squad-names";
        names.textContent = item.roles.join(" / ");
        row.appendChild(names);

        const wrap = document.createElement("div");
        wrap.className = "squad-bar-wrap";
        const bar = document.createElement("div");
        bar.className = "squad-bar";
        bar.style.width = (item.count / maxCount * 100) + "%";
        wrap.appendChild(bar);
        row.appendChild(wrap);

        const cnt = document.createElement("div");
        cnt.className = "squad-count";
        cnt.textContent = `${item.count} (${item.percent.toFixed(1)}%)`;
        row.appendChild(cnt);

        container.appendChild(row);
      });
    }

    function renderSquadUsageAll() {
      const usage = computeSquadUsage();
      renderSquadUsageList("squadUsageFront", usage.front);
      renderSquadUsageList("squadUsageBack",  usage.back);
    }

    /* ----------- Tabs 切換 ----------- */
    function setupTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;

          buttons.forEach(b => b.classList.remove("active"));
          panels.forEach(p => p.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(target).classList.add("active");
        });
      });
    }

    /* ----------- INIT ----------- */
    async function init() {
      setupTabs();
      allTeams = await loadCSV();
      filteredTeams = allTeams.slice();

      buildFilters();
      renderTeams(filteredTeams);

      renderRoleUsageAll();
      renderSquadUsageAll();
      loadLastUpdate();
    }

    init();
  </script>
</body>
</html>
